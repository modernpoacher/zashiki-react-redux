"use strict";function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj;};}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}return _typeof(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.map");require("core-js/modules/es.object.get-own-property-descriptor");require("core-js/modules/es.object.get-own-property-descriptors");require("core-js/modules/es.object.keys");require("core-js/modules/es.reflect.has");require("core-js/modules/web.dom-collections.for-each");Object.defineProperty(exports,"__esModule",{value:true});exports.watchAlphaRoute=watchAlphaRoute;exports.watchAlphaMount=watchAlphaMount;exports.watchAlphaFetch=watchAlphaFetch;exports.watchAlphaStore=watchAlphaStore;exports.watchAlphaQuery=watchAlphaQuery;exports.watchAlphaSubmit=watchAlphaSubmit;require("regenerator-runtime/runtime");var _debug=_interopRequireDefault(require("debug"));var _fastDeepEqual=_interopRequireDefault(require("fast-deep-equal"));var _effects=require("redux-saga/effects");var _signals=_interopRequireDefault(require("shinkansen-engine/lib/components/signals"));var _transmission=require("shinkansen-engine/lib/transformers/transmission");var _alpha=require("../../../actions/stages/alpha");var api=_interopRequireWildcard(require("../../../../api/stages/alpha"));var _transformers=require("../../../transformers");var _getPathname=_interopRequireDefault(require("../../../common/get-pathname"));function _getRequireWildcardCache(){if(typeof WeakMap!=="function")return null;var cache=new WeakMap();_getRequireWildcardCache=function _getRequireWildcardCache(){return cache;};return cache;}function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}if(obj===null||_typeof(obj)!=="object"&&typeof obj!=="function"){return{default:obj};}var cache=_getRequireWildcardCache();if(cache&&cache.has(obj)){return cache.get(obj);}var newObj={};var hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;if(desc&&(desc.get||desc.set)){Object.defineProperty(newObj,key,desc);}else{newObj[key]=obj[key];}}}newObj.default=obj;if(cache){cache.set(obj,newObj);}return newObj;}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var _marked=regeneratorRuntime.mark(alphaRouteSaga),_marked2=regeneratorRuntime.mark(mountRouteSaga),_marked3=regeneratorRuntime.mark(fetchRouteSaga),_marked4=regeneratorRuntime.mark(storeRouteSaga),_marked5=regeneratorRuntime.mark(queryRouteSaga),_marked6=regeneratorRuntime.mark(submitStateSaga),_marked7=regeneratorRuntime.mark(watchAlphaRoute),_marked8=regeneratorRuntime.mark(watchAlphaMount),_marked9=regeneratorRuntime.mark(watchAlphaFetch),_marked10=regeneratorRuntime.mark(watchAlphaStore),_marked11=regeneratorRuntime.mark(watchAlphaQuery),_marked12=regeneratorRuntime.mark(watchAlphaSubmit);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}var log=(0,_debug.default)('zashiki-react-redux:app:sagas:stages:alpha');var ALPHA=_signals.default.ALPHA;var getState=function getState(_ref){var _ref$ALPHA=_ref[ALPHA],alpha=_ref$ALPHA===void 0?{}:_ref$ALPHA;return alpha;};var getDefinition=function getDefinition(_ref2,RESOURCE){var _ref2$ALPHA=_ref2[ALPHA];_ref2$ALPHA=_ref2$ALPHA===void 0?{}:_ref2$ALPHA;var _ref2$ALPHA$omega=_ref2$ALPHA.omega,omega=_ref2$ALPHA$omega===void 0?[]:_ref2$ALPHA$omega;var _omega$find=omega.find(function(_ref3){var resource=_ref3.resource;return(0,_fastDeepEqual.default)(resource,RESOURCE);}),definition=_omega$find.definition;return definition;};var hasStoreError=function hasStoreError(_ref4){var _ref4$ALPHA=_ref4[ALPHA],alpha=_ref4$ALPHA===void 0?{}:_ref4$ALPHA;return'error'in alpha;};var hasQueryError=function hasQueryError(_ref5){var _ref5$ALPHA=_ref5[ALPHA],alpha=_ref5$ALPHA===void 0?{}:_ref5$ALPHA;return'error'in alpha;};function transformData(data){log('transformData');if(Reflect.has(data,'omega')){var _data$omega=data.omega,omega=_data$omega===void 0?[]:_data$omega;return _objectSpread(_objectSpread({},data),{},{omega:omega.map(function(item){var response=item.response,definition=item.definition;return _objectSpread(_objectSpread({},item),{},{response:(0,_transmission.fromDocumentToHash)(response,definition)});})});}return data;}function alphaRouteSaga(_ref6){var redirect,history,pathname,_history$location,currentPathname;return regeneratorRuntime.wrap(function alphaRouteSaga$(_context){while(1){switch(_context.prev=_context.next){case 0:redirect=_ref6.redirect,history=_ref6.history;log('alphaRouteSaga');pathname=(0,_getPathname.default)(redirect);if(pathname){_history$location=history.location;_history$location=_history$location===void 0?{}:_history$location;currentPathname=_history$location.pathname;if(pathname!==currentPathname)history.push(pathname);}case 4:case"end":return _context.stop();}}},_marked);}function mountRouteSaga(_ref7){var route,_yield$call,_yield$call$data,data;return regeneratorRuntime.wrap(function mountRouteSaga$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:route=_ref7.route;log('mountRouteSaga');_context2.prev=2;_context2.next=5;return(0,_effects.call)(api.mountRoute,route);case 5:_yield$call=_context2.sent;_yield$call$data=_yield$call.data;data=_yield$call$data===void 0?{}:_yield$call$data;_context2.next=10;return(0,_effects.put)((0,_alpha.mountRouteFulfilled)(transformData(data)));case 10:_context2.next=16;break;case 12:_context2.prev=12;_context2.t0=_context2["catch"](2);_context2.next=16;return(0,_effects.put)((0,_alpha.mountRouteRejected)((0,_transformers.transformError)(_context2.t0)));case 16:case"end":return _context2.stop();}}},_marked2,null,[[2,12]]);}function fetchRouteSaga(){var _yield$call2,_yield$call2$data,data;return regeneratorRuntime.wrap(function fetchRouteSaga$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:log('fetchRouteSaga');_context3.prev=1;_context3.next=4;return(0,_effects.call)(api.fetchRoute);case 4:_yield$call2=_context3.sent;_yield$call2$data=_yield$call2.data;data=_yield$call2$data===void 0?{}:_yield$call2$data;_context3.next=9;return(0,_effects.put)((0,_alpha.fetchRouteFulfilled)(transformData(data)));case 9:_context3.next=15;break;case 11:_context3.prev=11;_context3.t0=_context3["catch"](1);_context3.next=15;return(0,_effects.put)((0,_alpha.fetchRouteRejected)((0,_transformers.transformError)(_context3.t0)));case 15:case"end":return _context3.stop();}}},_marked3,null,[[1,11]]);}function storeRouteSaga(_ref8){var route,_yield$call3,_yield$call3$data,data;return regeneratorRuntime.wrap(function storeRouteSaga$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:route=_ref8.route;log('storeRouteSaga');_context4.prev=2;_context4.next=5;return(0,_effects.call)(api.storeRoute,route);case 5:_yield$call3=_context4.sent;_yield$call3$data=_yield$call3.data;data=_yield$call3$data===void 0?{}:_yield$call3$data;_context4.next=10;return(0,_effects.put)((0,_alpha.storeRouteFulfilled)(transformData(data)));case 10:_context4.next=16;break;case 12:_context4.prev=12;_context4.t0=_context4["catch"](2);_context4.next=16;return(0,_effects.put)((0,_alpha.storeRouteRejected)((0,_transformers.transformError)(_context4.t0)));case 16:case"end":return _context4.stop();}}},_marked4,null,[[2,12]]);}function queryRouteSaga(){var _yield$call4,_yield$call4$data,data;return regeneratorRuntime.wrap(function queryRouteSaga$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:log('queryRouteSaga');_context5.prev=1;_context5.next=4;return(0,_effects.call)(api.queryRoute);case 4:_yield$call4=_context5.sent;_yield$call4$data=_yield$call4.data;data=_yield$call4$data===void 0?{}:_yield$call4$data;_context5.next=9;return(0,_effects.put)((0,_alpha.queryRouteFulfilled)(transformData(data)));case 9:_context5.next=15;break;case 11:_context5.prev=11;_context5.t0=_context5["catch"](1);_context5.next=15;return(0,_effects.put)((0,_alpha.queryRouteRejected)((0,_transformers.transformError)(_context5.t0)));case 15:case"end":return _context5.stop();}}},_marked5,null,[[1,11]]);}function submitStateSaga(_ref9){var _ref9$route,resource,response,history,definition,hasError,state,_hasError,_state,redirect,_history;return regeneratorRuntime.wrap(function submitStateSaga$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_ref9$route=_ref9.route,resource=_ref9$route.resource,response=_ref9$route.response,history=_ref9.history;log('submitStateSaga');_context6.next=4;return(0,_effects.call)(api.mountRoute,{resource:resource});case 4:_context6.next=6;return(0,_effects.select)(getDefinition,resource);case 6:definition=_context6.sent;_context6.next=9;return(0,_effects.put)((0,_alpha.storeRoute)({resource:resource,response:(0,_transmission.fromHashToDocument)(response,definition)},history));case 9:_context6.next=11;return(0,_effects.race)([(0,_effects.take)(_alpha.STORE_FULFILLED),(0,_effects.take)(_alpha.STORE_REJECTED)]);case 11:_context6.next=13;return(0,_effects.select)(hasStoreError);case 13:hasError=_context6.sent;if(hasError){_context6.next=36;break;}_context6.next=17;return(0,_effects.select)(getState);case 17:state=_context6.sent;_context6.next=20;return(0,_effects.put)((0,_alpha.submitStateFulfilled)(state));case 20:_context6.next=22;return(0,_effects.put)((0,_alpha.queryRoute)());case 22:_context6.next=24;return(0,_effects.race)([(0,_effects.take)(_alpha.QUERY_FULFILLED),(0,_effects.take)(_alpha.QUERY_REJECTED)]);case 24:_context6.next=26;return(0,_effects.select)(hasQueryError);case 26:_hasError=_context6.sent;if(_hasError){_context6.next=34;break;}_context6.next=30;return(0,_effects.select)(getState);case 30:_state=_context6.sent;redirect=_state.redirect,_history=_state.history;_context6.next=34;return(0,_effects.put)((0,_alpha.alphaRoute)(redirect,_history));case 34:_context6.next=38;break;case 36:_context6.next=38;return(0,_effects.put)((0,_alpha.submitStateRejected)());case 38:case"end":return _context6.stop();}}},_marked6);}function watchAlphaRoute(){return regeneratorRuntime.wrap(function watchAlphaRoute$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return(0,_effects.takeLatest)(_alpha.ROUTE,alphaRouteSaga);case 2:case"end":return _context7.stop();}}},_marked7);}function watchAlphaMount(){return regeneratorRuntime.wrap(function watchAlphaMount$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return(0,_effects.takeLatest)(_alpha.MOUNT,mountRouteSaga);case 2:case"end":return _context8.stop();}}},_marked8);}function watchAlphaFetch(){return regeneratorRuntime.wrap(function watchAlphaFetch$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return(0,_effects.takeLatest)(_alpha.FETCH,fetchRouteSaga);case 2:case"end":return _context9.stop();}}},_marked9);}function watchAlphaStore(){return regeneratorRuntime.wrap(function watchAlphaStore$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:_context10.next=2;return(0,_effects.takeLatest)(_alpha.STORE,storeRouteSaga);case 2:case"end":return _context10.stop();}}},_marked10);}function watchAlphaQuery(){return regeneratorRuntime.wrap(function watchAlphaQuery$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.next=2;return(0,_effects.takeLatest)(_alpha.QUERY,queryRouteSaga);case 2:case"end":return _context11.stop();}}},_marked11);}function watchAlphaSubmit(){return regeneratorRuntime.wrap(function watchAlphaSubmit$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:_context12.next=2;return(0,_effects.takeLatest)(_alpha.SUBMIT,submitStateSaga);case 2:case"end":return _context12.stop();}}},_marked12);}